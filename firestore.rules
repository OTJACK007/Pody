rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function hasValidFields(requiredFields) {
      return request.resource.data.keys().hasAll(requiredFields);
    }

    function isValidEmail(email) {
      return email.matches('^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$');
    }

    // User Settings
    match /userSettings/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Social Accounts
    match /userSocialAccounts/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // Security Logs
    match /securityLogs/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Profile pictures
    match /profilePictures/{userId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
                  request.auth.uid == userId &&
                  request.resource.size < 5 * 1024 * 1024 && // 5MB max
                  request.resource.contentType.matches('image/.*');
    }

    // Social media assets
    match /socialMedia/{userId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
                  request.auth.uid == userId &&
                  request.resource.size < 10 * 1024 * 1024;
    }

    // Billing documents
    match /billing/{userId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only backend can write billing documents
    }
  }
}